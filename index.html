<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê≥®Èü≥ËΩâÁõ§ÈÅäÊà≤-Âö¥Ê†ºÂ≠óÂÖ∏Áâà</title>
    <style>
        :root {
            --primary-color: #FF9AA2;
            --bg-color: #FFF9F2;
            --text-color: #333;
            --wheel-border: #fff;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto; 
            padding: 20px 0;
        }

        h1 {
            color: #666;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
            text-align: center;
            font-weight: 800;
            letter-spacing: 2px;
            font-size: 28px;
        }

        .game-container {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; 
            -webkit-user-select: none;
        }

        .pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #FF6F91;
            z-index: 100;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
        }

        .wheel {
            position: absolute;
            border-radius: 50%;
            transition: transform 4s cubic-bezier(0.1, 0, 0.2, 1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: white;
        }

        .wheel-item {
            position: absolute;
            top: 0;
            left: 50%;
            transform-origin: 50% 100%;
            display: flex;
            justify-content: center;
            padding-top: 5px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.6);
            box-sizing: border-box;
            user-select: none;
        }

        /* Â§ñÂ±§ÔºöËÅ≤ÊØç */
        .outer-ring {
            width: 340px;
            height: 340px;
            z-index: 1;
            font-size: 18px;
        }
        .outer-ring .wheel-item {
            height: 170px;
            width: 40px;
            margin-left: -20px;
        }

        /* ‰∏≠Â±§ÔºöÈüªÊØç */
        .middle-ring {
            width: 240px;
            height: 240px;
            z-index: 2;
            font-size: 20px;
            border: 4px solid var(--wheel-border);
        }
        .middle-ring .wheel-item {
            height: 120px;
            width: 40px;
            margin-left: -20px;
            padding-top: 5px;
        }

        /* ÂÖßÂ±§ÔºöËÅ≤Ë™ø */
        .inner-ring {
            width: 140px;
            height: 140px;
            z-index: 3;
            font-size: 24px;
            border: 4px solid var(--wheel-border);
        }
        .inner-ring .wheel-item {
            height: 70px;
            width: 60px;
            margin-left: -30px;
            padding-top: 15px;
        }

        .center-btn {
            position: absolute;
            width: 65px;
            height: 65px;
            background: radial-gradient(circle at 30% 30%, #FFB7B2, #FF9AA2);
            border-radius: 50%;
            z-index: 10;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(255, 154, 162, 0.4);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #333;
            font-size: 18px;
            transition: transform 0.1s;
        }

        .center-btn:active {
            transform: scale(0.95);
        }

        .result-panel {
            margin-top: 25px;
            background: white;
            padding: 20px 35px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            min-width: 280px;
            z-index: 10;
            border: 2px solid #FFF0F5; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-labels {
            display: flex;
            justify-content: space-around;
            font-size: 15px;
            color: #888;
            margin-bottom: 8px;
            font-weight: bold;
            width: 100%;
        }

        .result-boxes {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .result-box {
            width: 65px;
            height: 65px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .box-initial { background-color: #FF9AA2; }
        .box-final { background-color: #88D8B0; }
        .box-tone { background-color: #FFDAC1; }
        
        .full-sound {
            margin-top: 15px;
            font-size: 22px;
            color: #666;
            height: 28px;
            font-weight: bold;
        }

        /* Êñ∞Â¢ûÔºöÊúóËÆÄÊåâÈàïÊ®£Âºè */
        .speak-btn {
            margin-top: 15px;
            padding: 8px 24px;
            background-color: #4ECDC4;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: none; /* È†êË®≠Èö±ËóèÔºåÊúâÁµêÊûúÊâçÈ°ØÁ§∫ */
            align-items: center;
            gap: 5px;
        }

        .speak-btn:hover {
            background-color: #36b9b0;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .speak-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 400px) {
            .game-container {
                transform: scale(0.85);
            }
            .result-panel {
                min-width: 260px;
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>

    <h1>Ê≥®Èü≥ËΩâÁõ§ÈÅäÊà≤-Âö¥Ê†ºÂ≠óÂÖ∏Áâà</h1>

    <div class="game-container">
        <div class="pointer"></div>
        <div class="wheel outer-ring" id="wheel-initial"></div>
        <div class="wheel middle-ring" id="wheel-final"></div>
        <div class="wheel inner-ring" id="wheel-tone"></div>
        <div class="center-btn" onclick="spinWheel()">ÈñãÂßã</div>
    </div>

    <div class="result-panel">
        <div class="result-labels">
            <span style="width: 65px">ËÅ≤ÊØç</span>
            <span style="width: 65px">ÈüªÊØç</span>
            <span style="width: 65px">ËÅ≤Ë™ø</span>
        </div>
        <div class="result-boxes">
            <div class="result-box box-initial" id="res-initial">?</div>
            <div class="result-box box-final" id="res-final">?</div>
            <div class="result-box box-tone" id="res-tone">?</div>
        </div>
        <div class="full-sound" id="res-text">Ê∫ñÂÇôÈñãÂßã...</div>
        <!-- Êñ∞Â¢ûÔºöÊúóËÆÄÊåâÈàï -->
        <button class="speak-btn" onclick="speakResult()">üîä ËÅΩÁôºÈü≥</button>
    </div>

    <script>
        const initials = [
            '„ÑÖ','„ÑÜ','„Ñá','„Ñà','„Ñâ','„Ñä','„Ñã','„Ñå','„Ñç','„Ñé','„Ñè',
            '„Ñê','„Ñë','„Ñí','„Ñì','„Ñî','„Ñï','„Ññ','„Ñó','„Ñò','„Ñô'
        ];
        
        const finals = [
            '„Ñö','„Ñõ','„Ñú','„Ñù','„Ñû','„Ñü','„Ñ†','„Ñ°','„Ñ¢','„Ñ£','„Ñ§','„Ñ•','„Ñ¶',
            '„Ñß','„Ñ®','„Ñ©'
        ];
        
        // 0:‰∏ÄËÅ≤, 1:‰∫åËÅ≤, 2:‰∏âËÅ≤, 3:ÂõõËÅ≤
        const tones = [
            { label: ' ', name: '‰∏ÄËÅ≤', display: ' ' },
            { label: 'Àä', name: '‰∫åËÅ≤', display: 'Àä' },
            { label: 'Àá', name: '‰∏âËÅ≤', display: 'Àá' },
            { label: 'Àã', name: 'ÂõõËÅ≤', display: 'Àã' }
        ];

        // === Ë∂ÖÁ¥öÂö¥Ê†ºË≥áÊñôÂ∫´ (White List) ===
        // Ê†ºÂºè: 'ËÅ≤ÊØçÈüªÊØç': [ÂêàÊ≥ïËÅ≤Ë™øindex...]
        // 0:‰∏ÄËÅ≤, 1:‰∫åËÅ≤, 2:‰∏âËÅ≤, 3:ÂõõËÅ≤
        // ‰øÆÊ≠£: ÁßªÈô§‰∫ÜÁ¥¢ÂºïÁÇ∫ 4 (ËºïËÅ≤) ÁöÑÈåØË™§Ë≥áÊñô
        const toneDatabase = {
            // „ÑÖ (B)
            '„ÑÖ„Ñö': [0, 1, 2, 3], '„ÑÖ„Ñõ': [0, 1, 2, 3], '„ÑÖ„Ñû': [0, 1, 2, 3], '„ÑÖ„Ñü': [0, 2, 3], 
            '„ÑÖ„Ñ†': [0, 2, 3], '„ÑÖ„Ñ¢': [0, 2, 3], '„ÑÖ„Ñ£': [0, 2, 3], '„ÑÖ„Ñ§': [0, 2, 3], '„ÑÖ„Ñ•': [0, 2, 3],
            '„ÑÖ„Ñß': [0, 1, 2, 3], '„ÑÖ„Ñ®': [0, 2, 3],
            // „ÑÜ (P)
            '„ÑÜ„Ñö': [0, 1, 3], '„ÑÜ„Ñõ': [0, 1, 2, 3], '„ÑÜ„Ñû': [0, 1, 2, 3], '„ÑÜ„Ñü': [0, 1, 2, 3], 
            '„ÑÜ„Ñ†': [0, 1, 3], '„ÑÜ„Ñ°': [0, 3], '„ÑÜ„Ñ¢': [0, 1, 2, 3], '„ÑÜ„Ñ£': [0, 1, 3], 
            '„ÑÜ„Ñ§': [0, 1, 2], '„ÑÜ„Ñ•': [0, 1, 2, 3], '„ÑÜ„Ñß': [0, 1, 2, 3], '„ÑÜ„Ñ®': [0, 1, 2, 3],
            // „Ñá (M)
            '„Ñá„Ñö': [0, 1, 2, 3], '„Ñá„Ñõ': [0, 1, 2, 3], '„Ñá„Ñú': [0], 
            '„Ñá„Ñû': [1, 2, 3], '„Ñá„Ñü': [1, 2, 3], '„Ñá„Ñ†': [0, 1, 2, 3], '„Ñá„Ñ°': [1, 2, 3], 
            '„Ñá„Ñ¢': [1, 2, 3], '„Ñá„Ñ£': [1, 3], '„Ñá„Ñ§': [1, 2], '„Ñá„Ñ•': [0, 1, 2, 3], 
            '„Ñá„Ñß': [0, 1, 2, 3], '„Ñá„Ñ®': [0, 2, 3],
            // „Ñà (F)
            '„Ñà„Ñö': [0, 1, 2, 3], '„Ñà„Ñõ': [1], 
            '„Ñà„Ñü': [0, 1, 2, 3], '„Ñà„Ñ°': [2, 3], 
            '„Ñà„Ñ¢': [0, 1, 2, 3], '„Ñà„Ñ£': [0, 1, 2, 3], '„Ñà„Ñ§': [0, 1, 2, 3], '„Ñà„Ñ•': [0, 1, 2, 3], 
            '„Ñà„Ñ®': [0, 1, 2, 3],
            // „Ñâ (D)
            '„Ñâ„Ñö': [0, 1, 2, 3], '„Ñâ„Ñú': [1], 
            '„Ñâ„Ñû': [0, 2, 3], '„Ñâ„Ñ†': [0, 2, 3], '„Ñâ„Ñ°': [0, 2, 3], 
            '„Ñâ„Ñ¢': [0, 2, 3], '„Ñâ„Ñ£': [3], 
            '„Ñâ„Ñ§': [0, 2, 3], '„Ñâ„Ñ•': [0, 2, 3], '„Ñâ„Ñß': [0, 1, 2, 3], '„Ñâ„Ñ®': [0, 1, 2, 3],
            // „Ñä (T)
            '„Ñä„Ñö': [0, 2, 3], '„Ñä„Ñú': [3], 
            '„Ñä„Ñû': [0, 1, 2, 3], '„Ñä„Ñ†': [0, 1, 2, 3], '„Ñä„Ñ°': [0, 1, 2, 3], 
            '„Ñä„Ñ¢': [0, 1, 2, 3], '„Ñä„Ñ§': [0, 1, 2, 3], '„Ñä„Ñ•': [0, 1, 2], 
            '„Ñä„Ñß': [0, 1, 2, 3], '„Ñä„Ñ®': [0, 1, 2, 3],
            // „Ñã (N)
            '„Ñã„Ñö': [1, 2, 3], '„Ñã„Ñú': [3], 
            '„Ñã„Ñû': [2, 3], '„Ñã„Ñü': [2, 3], '„Ñã„Ñ†': [1, 2, 3], '„Ñã„Ñ°': [3], 
            '„Ñã„Ñ¢': [0, 1, 2, 3], '„Ñã„Ñ£': [3], '„Ñã„Ñ§': [1, 2, 3], '„Ñã„Ñ•': [1, 2], 
            '„Ñã„Ñß': [0, 1, 2, 3], '„Ñã„Ñ®': [1, 2, 3], '„Ñã„Ñ©': [2, 3],
            // „Ñå (L)
            '„Ñå„Ñö': [0, 1, 2, 3], '„Ñå„Ñõ': [1], // ‰øÆÊ≠£: ÁßªÈô§ 4
            '„Ñå„Ñú': [3], 
            '„Ñå„Ñû': [1, 3], '„Ñå„Ñü': [1, 2, 3], '„Ñå„Ñ†': [0, 1, 2, 3], '„Ñå„Ñ°': [0, 1, 2, 3], 
            '„Ñå„Ñ¢': [1, 2, 3], '„Ñå„Ñ§': [1, 2, 3], '„Ñå„Ñ•': [0, 1, 3], 
            '„Ñå„Ñß': [0, 1, 2, 3], '„Ñå„Ñ®': [0, 1, 2, 3], '„Ñå„Ñ©': [1, 2, 3],
            // „Ñç (G)
            '„Ñç„Ñö': [0, 1, 3], '„Ñç„Ñú': [0, 1, 2, 3], '„Ñç„Ñû': [0, 2, 3], '„Ñç„Ñü': [2], 
            '„Ñç„Ñ†': [0, 2, 3], '„Ñç„Ñ°': [0, 3], '„Ñç„Ñ¢': [0, 2, 3], '„Ñç„Ñ£': [0, 2, 3], 
            '„Ñç„Ñ§': [0, 2, 3], '„Ñç„Ñ•': [0, 2, 3], '„Ñç„Ñ®': [0, 2, 3],
            // „Ñé (K)
            '„Ñé„Ñö': [0, 2, 3], '„Ñé„Ñú': [0, 1, 2, 3], '„Ñé„Ñû': [0, 2, 3], '„Ñé„Ñ†': [0, 2, 3], 
            '„Ñé„Ñ°': [0, 3], '„Ñé„Ñ¢': [0, 1, 2, 3], '„Ñé„Ñ£': [0, 2, 3], '„Ñé„Ñ§': [0, 1, 2, 3], 
            '„Ñé„Ñ•': [0, 3], '„Ñé„Ñ®': [0, 2, 3],
            // „Ñè (H)
            '„Ñè„Ñö': [0, 1, 2, 3], '„Ñè„Ñú': [0, 1, 2, 3], '„Ñè„Ñû': [0, 1, 2, 3], '„Ñè„Ñü': [0], 
            '„Ñè„Ñ†': [0, 1, 2, 3], '„Ñè„Ñ°': [0, 2, 3], '„Ñè„Ñ¢': [0, 1, 2, 3], '„Ñè„Ñ£': [0, 2, 3], 
            '„Ñè„Ñ§': [0, 1, 2, 3], '„Ñè„Ñ•': [0, 1, 2, 3], '„Ñè„Ñ®': [0, 1, 2, 3],
            // „Ñê (J)
            '„Ñê„Ñß': [0, 1, 2, 3], '„Ñê„Ñ©': [0, 1, 2, 3],
            // „Ñë (Q)
            '„Ñë„Ñß': [0, 1, 2, 3], '„Ñë„Ñ©': [0, 1, 2, 3],
            // „Ñí (X)
            '„Ñí„Ñß': [0, 1, 2, 3], '„Ñí„Ñ©': [0, 1, 2, 3],
            // „Ñì (Zh)
            '„Ñì„Ñö': [0, 1, 2, 3], '„Ñì„Ñú': [0, 1, 2, 3], '„Ñì„Ñû': [0, 1, 2, 3], 
            '„Ñì„Ñ†': [0, 1, 2, 3], '„Ñì„Ñ°': [0, 1, 2, 3], '„Ñì„Ñ¢': [0, 2, 3], '„Ñì„Ñ£': [0, 2, 3], 
            '„Ñì„Ñ§': [0, 2, 3], '„Ñì„Ñ•': [0, 2, 3], '„Ñì„Ñ®': [0, 1, 2, 3],
            // „Ñî (Ch)
            '„Ñî„Ñö': [0, 1, 2, 3], '„Ñî„Ñú': [0, 2, 3], '„Ñî„Ñû': [0, 1, 3], 
            '„Ñî„Ñ†': [0, 1, 2, 3], '„Ñî„Ñ°': [0, 1, 2, 3], '„Ñî„Ñ¢': [0, 1, 2, 3], '„Ñî„Ñ£': [0, 1, 2, 3], 
            '„Ñî„Ñ§': [0, 1, 2, 3], '„Ñî„Ñ•': [0, 1, 2, 3], '„Ñî„Ñ®': [0, 1, 2, 3],
            // „Ñï (Sh)
            '„Ñï„Ñö': [0, 2, 3], '„Ñï„Ñú': [0, 1, 2, 3], '„Ñï„Ñû': [0, 3], 
            '„Ñï„Ñ†': [0, 1, 2, 3], '„Ñï„Ñ°': [0, 2, 3], '„Ñï„Ñ¢': [0, 2, 3], '„Ñï„Ñ£': [0, 1, 2, 3], 
            '„Ñï„Ñ§': [0, 2, 3], '„Ñï„Ñ•': [0, 1, 2, 3], '„Ñï„Ñ®': [0, 1, 2, 3],
            // „Ññ (R)
            '„Ññ„Ñú': [3], '„Ññ„Ñ†': [1, 2, 3], '„Ññ„Ñ°': [1, 3], '„Ññ„Ñ¢': [1, 2, 3], 
            '„Ññ„Ñ£': [1, 2, 3], '„Ññ„Ñ§': [1, 2, 3], '„Ññ„Ñ•': [0, 1], '„Ññ„Ñ®': [1, 2, 3],
            // „Ñó (Z)
            '„Ñó„Ñö': [0, 1, 2], '„Ñó„Ñú': [0, 1, 2, 3], '„Ñó„Ñû': [0, 3], 
            '„Ñó„Ñ†': [0, 2, 3], '„Ñó„Ñ°': [0, 2, 3], '„Ñó„Ñ¢': [0, 1, 3], '„Ñó„Ñ£': [2], 
            '„Ñó„Ñ§': [0, 1, 3], '„Ñó„Ñ•': [0, 3], '„Ñó„Ñ®': [0, 1, 2, 3],
            // „Ñò (C)
            '„Ñò„Ñö': [0, 1], '„Ñò„Ñú': [3], '„Ñò„Ñû': [0, 1, 2, 3], 
            '„Ñò„Ñ†': [0, 2, 3], '„Ñò„Ñ°': [0, 3], '„Ñò„Ñ¢': [0, 1, 2, 3], '„Ñò„Ñ£': [0, 1], 
            '„Ñò„Ñ§': [0, 1, 2], '„Ñò„Ñ•': [0, 1, 2, 3], '„Ñò„Ñ®': [0, 1, 2, 3],
            // „Ñô (S)
            '„Ñô„Ñö': [0, 2, 3], '„Ñô„Ñú': [3], '„Ñô„Ñû': [0, 3], 
            '„Ñô„Ñ†': [0, 2, 3], '„Ñô„Ñ°': [0, 2, 3], '„Ñô„Ñ¢': [0, 2, 3], '„Ñô„Ñ£': [0], 
            '„Ñô„Ñ§': [0, 2, 3], '„Ñô„Ñ•': [0], '„Ñô„Ñ®': [0, 1, 2, 3]
        };

        const colors = [
            '#FF9AA2', '#B5EAD7', '#FFDAC1', '#90CCF4', '#F3D250', 
            '#C7CEEA', '#FAB1A0', '#81ECEC', '#FFB7B2', '#E2F0CB', '#957DAD'
        ];

        let rotInitial = 0;
        let rotFinal = 0;
        let rotTone = 0;
        let currentSpeechText = '';

        // Ê†πÊìö toneDatabase Ëá™ÂãïÁî¢ÁîüÊØè‰∏ÄÂÄãËÅ≤ÊØçÁöÑÂêàÊ≥ïÈüªÊØçÂàóË°®
        // ÈÄôÊ®£Â∞±‰∏çÈúÄË¶ÅÊâãÂãïÁ∂≠Ë≠∑ validRules ‰∫Ü
        const validMap = {};
        
        // ÂàùÂßãÂåñ validMap
        initials.forEach(i => validMap[i] = []);
        
        // ÈÅçÊ≠∑Ë≥áÊñôÂ∫´Â°´ÂÖ•
        for (let key in toneDatabase) {
            let i = '';
            let f = '';
            // ÊãÜËß£ key (‰æãÂ¶Ç "„ÑÖ„Ñö" -> "„ÑÖ", "„Ñö")
            // ËÅ≤ÊØçÊúâ 1 ÂÄãÂ≠óÔºåÈüªÊØçÊúâ 1 ÂÄãÂ≠ó
            // Ê≥®ÊÑèÔºöÈÄôË£°ÂÅáË®≠ËÅ≤ÊØçÈÉΩÊòØÂñÆÂ≠ó
            i = key.substring(0, 1);
            f = key.substring(1);
            
            if (validMap[i] && !validMap[i].includes(f)) {
                validMap[i].push(f);
            }
        }

        function createWheel(id, items, radius) {
            const wheel = document.getElementById(id);
            const count = items.length;
            const anglePerItem = 360 / count;
            
            let gradientStr = '';
            items.forEach((item, index) => {
                const startDeg = index * anglePerItem;
                const endDeg = (index + 1) * anglePerItem;
                const color = colors[index % colors.length];
                gradientStr += `${color} ${startDeg}deg ${endDeg}deg,`;
                
                const el = document.createElement('div');
                el.className = 'wheel-item';
                const itemCenterDeg = startDeg + (anglePerItem / 2);
                
                el.style.transform = `rotate(${itemCenterDeg}deg)`;
                
                let displayText = typeof item === 'object' ? item.display : item;
                el.innerHTML = displayText;

                wheel.appendChild(el);
            });
            wheel.style.background = `conic-gradient(${gradientStr.slice(0, -1)})`;
        }

        function init() {
            createWheel('wheel-initial', initials, 170);
            createWheel('wheel-final', finals, 120);
            createWheel('wheel-tone', tones, 70);
        }

        function getRandomValidCombo() {
            let safetyCounter = 0;
            while(safetyCounter < 500) { 
                safetyCounter++;
                
                const randomInitial = initials[Math.floor(Math.random() * initials.length)];
                
                const allowedFinals = validMap[randomInitial];
                
                if (!allowedFinals || allowedFinals.length === 0) continue;

                const randomFinalChar = allowedFinals[Math.floor(Math.random() * allowedFinals.length)];
                
                const key = randomInitial + randomFinalChar;
                const allowedTonesIndices = toneDatabase[key];
                
                if (!allowedTonesIndices || allowedTonesIndices.length === 0) continue;
                
                // === ÂÆâÂÖ®ÈÅéÊøæÔºöÁ¢∫‰øùÁ¥¢Âºï‰∏çË∂ÖÈÅé tones Èô£ÂàóÈï∑Â∫¶ ===
                const validTonesIndices = allowedTonesIndices.filter(idx => idx >= 0 && idx < tones.length);
                if (validTonesIndices.length === 0) continue;
                
                const randomToneIndex = validTonesIndices[Math.floor(Math.random() * validTonesIndices.length)];
                const randomTone = tones[randomToneIndex];

                if (!randomTone) continue; // Double check

                return {
                    iIdx: initials.indexOf(randomInitial),
                    fIdx: finals.indexOf(randomFinalChar),
                    tIdx: randomToneIndex, 
                    val: { i: randomInitial, f: randomFinalChar, t: randomTone }
                };
            }
            
            // Fallback (‰ª•Èò≤Ëê¨‰∏Ä)
            return { 
                iIdx: 0, fIdx: 0, tIdx: 0, 
                val: { i: '„ÑÖ', f: '„Ñö', t: tones[0] } 
            };
        }

        function spinWheel() {
            const btn = document.querySelector('.center-btn');
            btn.style.pointerEvents = 'none';
            btn.innerText = '...';
            // ÊóãËΩâÊôÇÈö±ËóèÁôºÈü≥ÊåâÈàï
            document.querySelector('.speak-btn').style.display = 'none';

            const target = getRandomValidCombo();

            const calcTargetRotation = (idx, count, currentRot) => {
                const angleStep = 360 / count;
                const itemCenter = (idx * angleStep) + (angleStep / 2);
                const degreesToRotate = 360 - itemCenter;
                const currentFullSpins = Math.floor(currentRot / 360);
                const targetFullSpins = currentFullSpins + 5; 
                return (targetFullSpins * 360) + degreesToRotate;
            };

            rotInitial = calcTargetRotation(target.iIdx, initials.length, rotInitial);
            rotFinal = calcTargetRotation(target.fIdx, finals.length, rotFinal);
            rotTone = calcTargetRotation(target.tIdx, tones.length, rotTone);

            document.getElementById('wheel-initial').style.transform = `rotate(${rotInitial}deg)`;
            
            setTimeout(() => {
                document.getElementById('wheel-final').style.transform = `rotate(${rotFinal}deg)`;
            }, 200);

            setTimeout(() => {
                document.getElementById('wheel-tone').style.transform = `rotate(${rotTone}deg)`;
            }, 400);

            setTimeout(() => {
                showResult(target.val.i, target.val.f, target.val.t);
                btn.style.pointerEvents = 'auto';
                btn.innerText = 'ÈñãÂßã';
            }, 4400);
        }

        function showResult(i, f, t) {
            document.getElementById('res-initial').innerText = i;
            document.getElementById('res-final').innerText = f;
            if (t) {
                document.getElementById('res-tone').innerText = t.display;
                const toneMark = t.display.trim(); 
                let fullText = `${i}${f}${toneMark}`;
                document.getElementById('res-text').innerText = `ÊãºÈü≥ÁµêÊûúÔºö${fullText}`;
                
                // ÂÑ≤Â≠òÊñáÂ≠ó‰∏¶È°ØÁ§∫ÁôºÈü≥ÊåâÈàï
                currentSpeechText = fullText;
                document.querySelector('.speak-btn').style.display = 'inline-flex';
            } else {
                 console.error("Tone is undefined", i, f);
            }

            const boxes = document.querySelectorAll('.result-box');
            boxes.forEach(box => {
                box.style.transform = 'scale(1.1)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            });
        }
        
        // ÂòóË©¶Áç≤ÂèñÊúÄ‰Ω≥ÁöÑ‰∏≠ÊñáË™ûÈü≥
        function getChineseVoice() {
            const voices = window.speechSynthesis.getVoices();
            // ÂÑ™ÂÖàÊâæÂè∞ÁÅ£‰∏≠Êñá -> ÂÖ∂Ê¨°Êâæ‰ªª‰Ωï‰∏≠Êñá -> Âê¶ÂâáÂõûÂÇ≥ null (‰ΩøÁî®È†êË®≠)
            return voices.find(v => v.lang === 'zh-TW') || 
                   voices.find(v => v.lang.startsWith('zh')) || null;
        }

        function speakResult() {
            if (!currentSpeechText) return;
            
            // ÂÅúÊ≠¢‰πãÂâçÁöÑÁôºÈü≥
            window.speechSynthesis.cancel();

            const u = new SpeechSynthesisUtterance(currentSpeechText);
            u.lang = 'zh-TW'; // Ë®≠ÂÆöÁÇ∫Âè∞ÁÅ£‰∏≠Êñá
            
            // ÂòóË©¶Ë®≠ÂÆöÂÖ∑È´îÁöÑË™ûÈü≥ÂåÖ
            const chineseVoice = getChineseVoice();
            if (chineseVoice) {
                u.voice = chineseVoice;
            }
            
            u.rate = 0.5; // ÈÄüÂ∫¶Ë™øÊÖ¢Ëá≥ 0.5 (ÂéüÊú¨ÊòØ 0.8)
            u.volume = 1; // Èü≥ÈáèË®≠ÂÆöÁÇ∫ÊúÄÂ§ß 1
            window.speechSynthesis.speak(u);
        }
        
        // Á¢∫‰øùË™ûÈü≥ÂàóË°®ËºâÂÖ•
        window.speechSynthesis.onvoiceschanged = () => {
            console.log("Voices loaded");
        };

        // ÂàùÂßãÂåñ
        init();

    </script>
</body>
</html>
